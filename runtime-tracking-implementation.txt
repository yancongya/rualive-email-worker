/**
 * 运行时间跟踪实现代码
 * 将此代码添加到 src/index.js 的 saveWorkData 函数中
 */

// ========== 在 saveWorkData 函数的最后，.run() 之前添加以下代码 ==========

  // 保存运行时间数据到 projects 和 project_daily_stats 表
  await saveProjectRuntimeData(userId, projectMap, workDate, env);

// ========== 添加 saveProjectRuntimeData 函数 ==========

/**
 * 保存项目运行时间数据到数据库
 * @param {string} userId - 用户ID
 * @param {Map} projectMap - 项目映射（包含项目信息）
 * @param {string} workDate - 工作日期
 * @param {Object} env - 环境变量
 */
async function saveProjectRuntimeData(userId, projectMap, workDate, env) {
  const DB = env.DB || env.rualive;
  
  if (!DB) {
    console.error('[saveProjectRuntimeData] Database not available');
    return;
  }

  try {
    console.log('[saveProjectRuntimeData] 开始保存项目运行时间数据');
    
    const now = new Date().toISOString();
    
    // 遍历所有项目，保存或更新项目数据和每日统计
    for (const [projectName, project] of projectMap.entries()) {
      try {
        const projectId = project.projectId || generateProjectId(project.path || projectName);
        const projectPath = project.path || '';
        const accumulatedRuntime = project.accumulatedRuntime || 0; // 秒
        
        // 1. 保存或更新 projects 表
        const existingProject = await DB.prepare(
          'SELECT id, total_work_hours, total_work_days FROM projects WHERE project_id = ?'
        ).bind(projectId).first();
        
        if (existingProject) {
          // 更新现有项目
          const workHours = accumulatedRuntime / 3600;
          const newTotalWorkHours = existingProject.total_work_hours + workHours;
          
          await DB.prepare(`
            UPDATE projects SET
              project_name = ?,
              project_path = ?,
              last_work_date = ?,
              total_work_hours = total_work_hours + ?,
              updated_at = ?
            WHERE id = ?
          `).bind(
            projectName,
            projectPath,
            workDate,
            workHours,
            now,
            existingProject.id
          ).run();
          
          console.log('[saveProjectRuntimeData] 更新项目:', projectName, '新增工作时长:', workHours.toFixed(2), '小时');
        } else {
          // 插入新项目
          const workHours = accumulatedRuntime / 3600;
          
          await DB.prepare(`
            INSERT INTO projects (
              user_id, project_id, project_name, project_path,
              first_work_date, last_work_date,
              total_work_hours, total_work_days,
              created_at, updated_at
            ) VALUES (?, ?, ?, ?, ?, ?, ?, 1, ?, ?)
          `).bind(
            userId,
            projectId,
            projectName,
            projectPath,
            workDate,
            workDate,
            workHours,
            now,
            now
          ).run();
          
          console.log('[saveProjectRuntimeData] 创建新项目:', projectName, '工作时长:', workHours.toFixed(2), '小时');
        }
        
        // 2. 保存或更新 project_daily_stats 表
        const dbProject = await DB.prepare(
          'SELECT id FROM projects WHERE project_id = ?'
        ).bind(projectId).first();
        
        if (dbProject) {
          const existingDailyStats = await DB.prepare(
            'SELECT id, work_hours FROM project_daily_stats WHERE project_id = ? AND work_date = ?'
          ).bind(dbProject.id, workDate).first();
          
          if (existingDailyStats) {
            // 更新现有每日统计
            const workHours = accumulatedRuntime / 3600;
            
            await DB.prepare(`
              UPDATE project_daily_stats SET
                work_hours = ?,
                accumulated_runtime = ?,
                composition_count = ?,
                layer_count = ?,
                keyframe_count = ?,
                effect_count = ?,
                created_at = ?
              WHERE id = ?
            `).bind(
              workHours,
              accumulatedRuntime,
              project.statistics?.compositions || 0,
              project.statistics?.layers || 0,
              project.statistics?.keyframes || 0,
              project.statistics?.effects || 0,
              now,
              existingDailyStats.id
            ).run();
            
            console.log('[saveProjectRuntimeData] 更新每日统计:', projectName, '日期:', workDate, '工作时长:', workHours.toFixed(2), '小时');
          } else {
            // 插入新的每日统计
            const workHours = accumulatedRuntime / 3600;
            
            await DB.prepare(`
              INSERT INTO project_daily_stats (
                project_id, work_date, work_hours, accumulated_runtime,
                composition_count, layer_count, keyframe_count, effect_count,
                created_at
              ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
            `).bind(
              dbProject.id,
              workDate,
              workHours,
              accumulatedRuntime,
              project.statistics?.compositions || 0,
              project.statistics?.layers || 0,
              project.statistics?.keyframes || 0,
              project.statistics?.effects || 0,
              now
            ).run();
            
            console.log('[saveProjectRuntimeData] 创建每日统计:', projectName, '日期:', workDate, '工作时长:', workHours.toFixed(2), '小时');
          }
        }
      } catch (error) {
        console.error('[saveProjectRuntimeData] 处理项目失败:', projectName, error);
      }
    }
    
    console.log('[saveProjectRuntimeData] 项目运行时间数据保存完成');
  } catch (error) {
    console.error('[saveProjectRuntimeData] 保存项目运行时间数据失败:', error);
    // 不抛出错误，因为这是附加功能
  }
}

/**
 * 生成项目ID（基于文件路径）
 * @param {string} projectPath - 项目路径
 * @returns {string} 项目ID（8位十六进制）
 */
function generateProjectId(projectPath) {
  if (!projectPath) {
    return Date.now().toString(16).substring(0, 8);
  }
  
  let hash = 0;
  for (let i = 0; i < projectPath.length; i++) {
    const char = projectPath.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // 转换为32位整数
  }
  
  const hashStr = Math.abs(hash).toString(16);
  return hashStr.substring(0, 8);
}

// ========== 添加 /api/projects/summary API 处理函数 ==========

/**
 * 处理项目摘要请求
 */
async function handleProjectSummary(request, env) {
  try {
    console.log('[handleProjectSummary] 开始处理项目摘要请求');
    
    // 验证用户权限
    const user = await verifyUserOnly(request, env);
    if (!user) {
      return Response.json({ error: '权限不足' }, { status: 403 });
    }
    
    const userId = user.id;
    const DB = env.DB || env.rualive;
    
    if (!DB) {
      return Response.json({ error: '数据库不可用' }, { status: 500 });
    }
    
    // 查询所有项目摘要
    const result = await DB.prepare(`
      SELECT 
        project_id,
        project_name,
        project_path,
        first_work_date,
        last_work_date,
        total_work_hours,
        total_work_days
      FROM projects
      WHERE user_id = ?
      ORDER BY total_work_hours DESC
    `).bind(userId).all();
    
    const projects = result.results.map(row => ({
      projectId: row.project_id,
      projectName: row.project_name,
      projectPath: row.project_path,
      firstWorkDate: row.first_work_date,
      lastWorkDate: row.last_work_date,
      totalWorkHours: row.total_work_hours,
      totalWorkDays: row.total_work_days
    }));
    
    console.log('[handleProjectSummary] 返回项目数量:', projects.length);
    
    return Response.json({ success: true, projects });
  } catch (error) {
    console.error('[handleProjectSummary] 处理请求失败:', error);
    return Response.json({ error: error.message }, { status: 500 });
  }
}

// ========== 添加 /api/projects/history API 处理函数 ==========

/**
 * 处理项目历史请求
 */
async function handleProjectHistory(request, env) {
  try {
    console.log('[handleProjectHistory] 开始处理项目历史请求');
    
    // 验证用户权限
    const user = await verifyUserOnly(request, env);
    if (!user) {
      return Response.json({ error: '权限不足' }, { status: 403 });
    }
    
    const userId = user.id;
    const url = new URL(request.url);
    const projectId = url.searchParams.get('projectId');
    const startDate = url.searchParams.get('startDate');
    const endDate = url.searchParams.get('endDate');
    
    if (!projectId) {
      return Response.json({ error: '缺少 projectId 参数' }, { status: 400 });
    }
    
    const DB = env.DB || env.rualive;
    
    if (!DB) {
      return Response.json({ error: '数据库不可用' }, { status: 500 });
    }
    
    // 获取项目信息
    const project = await DB.prepare(
      'SELECT id, project_name FROM projects WHERE project_id = ? AND user_id = ?'
    ).bind(projectId, userId).first();
    
    if (!project) {
      return Response.json({ error: '项目不存在' }, { status: 404 });
    }
    
    // 构建查询条件
    let query = 'SELECT work_date, work_hours, accumulated_runtime, composition_count, layer_count, keyframe_count, effect_count FROM project_daily_stats WHERE project_id = ?';
    const params = [project.id];
    
    if (startDate) {
      query += ' AND work_date >= ?';
      params.push(startDate);
    }
    
    if (endDate) {
      query += ' AND work_date <= ?';
      params.push(endDate);
    }
    
    query += ' ORDER BY work_date ASC';
    
    // 查询每日历史数据
    const result = await DB.prepare(query).bind(...params).all();
    
    const dailyStats = result.results.map(row => ({
      workDate: row.work_date,
      workHours: row.work_hours,
      accumulatedRuntime: row.accumulated_runtime,
      compositionCount: row.composition_count,
      layerCount: row.layer_count,
      keyframeCount: row.keyframe_count,
      effectCount: row.effect_count
    }));
    
    console.log('[handleProjectHistory] 返回每日数据数量:', dailyStats.length);
    
    return Response.json({ 
      success: true, 
      projectName: project.project_name,
      projectId: projectId,
      dailyStats 
    });
  } catch (error) {
    console.error('[handleProjectHistory] 处理请求失败:', error);
    return Response.json({ error: error.message }, { status: 500 });
  }
}

// ========== 在 export default 对象的路由处理部分添加以下代码 ==========

    // 项目相关 API
    if (path === '/api/projects/summary' && request.method === 'GET') {
      return handleProjectSummary(request, env);
    }

    if (path === '/api/projects/history' && request.method === 'GET') {
      return handleProjectHistory(request, env);
    }