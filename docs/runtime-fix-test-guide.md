# Worker 运行时间修复测试指南

## 修复概述

本次修复解决了 Worker 后端存储累积运行时间而非当天运行时间的问题，确保前端显示正确的每天数据。

### 修复内容

1. ✅ **计算当天运行时间**: 在 `saveWorkData` 函数中计算当天运行时间 = 当前累积 - 历史累积
2. ✅ **修复 project_daily_stats 表**: `work_hours` 字段存储当天运行时间，`accumulated_runtime` 存储累积运行时间
3. ✅ **修复 work_logs 表**: `work_hours` 字段存储当天总工作时长（所有项目的当天运行时间之和）
4. ✅ **添加详细日志**: 输出累积运行时间、当天运行时间、之前累积运行时间等关键信息

### 文件修改

- `rualive-email-worker/src/index.js` (Line 3298-3480)
  - 修改项目运行时间计算逻辑
  - 修复 `project_daily_stats` 更新和插入逻辑
  - 添加 `work_logs.work_hours` 重新计算逻辑

---

## 测试步骤

### 步骤 1: 部署修复后的 Worker

```bash
cd rualive-email-worker
npx wrangler deploy
```

### 步骤 2: 查看修复后的日志

修复后，每次上传数据时会输出详细的日志：

```
[saveWorkData] ========== 开始处理项目: 项目A ==========
[saveWorkData] 累积运行时长: 9.50 小时 ( 34200 秒)
[saveWorkData] 之前累积运行时长: 7.00 小时
[saveWorkData] 当天运行时长: 2.50 小时 ( 9000 秒)
[saveWorkData] 项目存在，将计算当天运行时间
[saveWorkData] ✅ 更新项目每日统计: 项目A 2026-01-30 当天时长: 2.50 小时
[saveWorkData] ========== 重新计算当天总工作时长 ==========
[saveWorkData] 当天总工作时长: 2.50 小时
[saveWorkData] ✅ 已更新 work_logs.work_hours 为当天总工作时长: 2.50 小时
```

### 步骤 3: 验证数据库数据

使用 Cloudflare D1 数据库控制台执行验证脚本：

```bash
# 1. 在 Cloudflare Dashboard 中打开 D1 数据库
# 2. 执行 tests/verify-runtime-fix.sql 脚本
# 3. 将 'YOUR_USER_ID' 替换为实际的用户ID
```

### 步骤 4: 检查前端显示

1. 打开用户页面
2. 查看每天的数据统计
3. 验证显示的是当天工作时长，而非累积运行时间

---

## 预期结果

### 修复前（错误）

| 项目 | 2026-01-28 | 2026-01-29 | 2026-01-30 | 总计 |
|------|-----------|-----------|-----------|------|
| 项目A | 5h | 7h | 9h | 9h ❌ |
| **问题**: 每天显示的是累积运行时间 | | | | |

### 修复后（正确）

| 项目 | 2026-01-28 | 2026-01-29 | 2026-01-30 | 总计 |
|------|-----------|-----------|-----------|------|
| 项目A | 2h | 2h | 5h | 9h ✅ |
| **正确**: 每天显示的是当天工作时长 | | | | |

---

## 数据库字段说明

### project_daily_stats 表

| 字段 | 含义 | 单位 | 示例 |
|------|------|------|------|
| `work_hours` | 当天运行时间 | 小时 | 2.50 |
| `accumulated_runtime` | 累积运行时间 | 秒 | 34200 |

### work_logs 表

| 字段 | 含义 | 单位 | 示例 |
|------|------|------|------|
| `work_hours` | 当天总工作时长 | 小时 | 2.50 |

### projects 表

| 字段 | 含义 | 单位 | 示例 |
|------|------|------|------|
| `total_work_hours` | 累积运行时间 | 小时 | 9.50 |
| `total_work_days` | 工作天数 | 天 | 3 |

---

## 常见问题

### Q1: 为什么需要重新计算 work_logs.work_hours？

**A**: 因为 `work_logs.work_hours` 需要存储当天所有项目的当天运行时间之和，而这个值只有在处理完所有项目后才能计算出来。

### Q2: 如果当天上传多次数据会发生什么？

**A**: 每次上传都会重新计算当天运行时间，使用覆盖而非累加策略，确保数据准确性。

### Q3: 历史数据怎么办？

**A**: 历史数据中的 `work_hours` 字段仍然存储的是累积运行时间。如果需要修复历史数据，可以执行数据迁移脚本。

### Q4: 如何验证修复是否成功？

**A**: 
1. 查看日志输出，确认计算了当天运行时间
2. 执行验证 SQL 脚本，检查数据一致性
3. 查看前端显示，确认显示的是当天工作时长

---

## 回滚方案

如果修复后出现问题，可以回滚到修复前的版本：

```bash
git checkout HEAD~1 rualive-email-worker/src/index.js
npx wrangler deploy
```

---

## 下一步

修复完成后，可以考虑：

1. ✅ 测试修复效果
2. ✅ 验证数据一致性
3. ⏳ 修复 AE 扩展端（发送当天运行时间）
4. ⏳ 迁移历史数据（可选）

---

**文档版本**: 1.0
**创建日期**: 2026-02-06
**作者**: iFlow CLI